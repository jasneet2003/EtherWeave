<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Collaborative Canvas</title>
    <style>
        /* Basic CSS Reset & Body Styling */
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: #1a1a1a;
            color: #e0e0e0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            overflow: hidden;
            touch-action: none; /* Prevents double-tap to zoom on mobile */
        }

        /* Header Styling */
        .header {
            text-align: center;
            margin-bottom: 20px;
        }
        .header h1 {
            margin: 0;
            font-size: 1.8em;
            color: #fff;
        }
        .header p {
            margin: 4px 0 0;
            color: #888;
        }
        #connect-button {
            background-color: #6d28d9;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            cursor: pointer;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        #connect-button:hover {
            background-color: #5b21b6;
        }

        /* Main Canvas Container */
        #canvas-container {
            display: grid;
            grid-template-columns: repeat(50, 1fr);
            grid-template-rows: repeat(50, 1fr);
            width: 90vmin; /* vmin makes it responsive to the smaller screen dimension */
            height: 90vmin;
            border: 2px solid #555;
            background-color: #333; /* Darker background for loading */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.5);
        }

        /* Individual Pixel Styling */
        .pixel {
            width: 100%;
            height: 100%;
            background-color: #f0f0f0; /* Default empty color */
            /* A subtle grid line effect */
            box-shadow: inset 0 0 0 0.5px #555; 
            cursor: pointer;
        }
        .pixel:hover {
            outline: 1px solid #fff;
            z-index: 10;
        }

        /* Color Palette Styling */
        #palette {
            margin-top: 20px;
            display: flex;
            gap: 15px;
        }
        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            cursor: pointer;
            border: 3px solid #444;
            transition: transform 0.2s ease, border-color 0.2s ease;
        }
        .color-option:hover {
            transform: scale(1.1);
        }
        .color-option.selected {
            border-color: #fff;
            transform: scale(1.2);
            box-shadow: 0 0 15px var(--glow-color, #fff);
        }

    </style>
</head>
<body>

    <div class="header">
        <h1>The Indore Canvas</h1>
        <p id="status-text">Please connect your wallet to begin.</p>
        <button id="connect-button">Connect Wallet</button>
    </div>

    <div id="canvas-container">
        <!-- The 2500 pixel divs will be generated here by JavaScript -->
    </div>

    <div id="palette">
        <!-- The color options will be generated here by JavaScript -->
    </div>

    <!-- 1. Include the Ethers.js library -->
    <script src="https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js" type="application/javascript"></script>

    <script>
        window.onload = function() {
            // --- ROBUST INITIALIZATION ---
            if (typeof ethers === 'undefined') {
                document.getElementById('status-text').textContent = "Fatal Error: Blockchain library failed to load.";
                return; 
            }

            // --- SETUP ---
            const canvasContainer = document.getElementById('canvas-container');
            const paletteContainer = document.getElementById('palette');
            const statusText = document.getElementById('status-text');
            const connectButton = document.getElementById('connect-button');
            const GRID_SIZE = 50;
            const COLORS = ["#FFFFFF", "#FFD700", "#FF5733", "#FF0000", "#0000FF", "#138808", "#000000"];
            let selectedColor = COLORS[0];
            let pixels; 

            // --- BLOCKCHAIN SETUP ---
            const contractAddress = "0x0C951fEA35cB08dC97a11af1432B504258486a05"; // Your contract address
            const contractABI = [{"inputs":[],"name":"getCanvas","outputs":[{"internalType":"string[50][50]","name":"","type":"string[50][50]"}],"stateMutability":"view","type":"function"},{"inputs":[{"internalType":"uint256","name":"x","type":"uint256"},{"internalType":"uint256","name":"y","type":"uint256"},{"internalType":"string","name":"color","type":"string"}],"name":"paintPixel","outputs":[],"stateMutability":"nonpayable","type":"function"},{"anonymous":false,"inputs":[{"indexed":false,"internalType":"uint256","name":"x","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"y","type":"uint256"},{"indexed":false,"internalType":"string","name":"color","type":"string"},{"indexed":false,"internalType":"address","name":"painter","type":"address"}],"name":"PixelPainted","type":"event"}];
            const SEPOLIA_CHAIN_ID = '0xaa36a7';
            
            let provider;
            let readOnlyContract;
            let writeableContract;
            let userWalletAddress;

            // --- FUNCTIONS ---

            async function checkAndSwitchNetwork() {
                try {
                    const currentChainId = await window.ethereum.request({ method: 'eth_chainId' });
                    if (currentChainId !== SEPOLIA_CHAIN_ID) {
                        statusText.textContent = "Wrong network. Please switch to Sepolia.";
                        await window.ethereum.request({
                            method: 'wallet_switchEthereumChain',
                            params: [{ chainId: SEPOLIA_CHAIN_ID }],
                        });
                    }
                    return true;
                } catch (switchError) {
                    console.error(switchError);
                    statusText.textContent = "Please switch to the Sepolia network in your wallet.";
                    return false;
                }
            }

            function createPalette() {
                COLORS.forEach((color, index) => {
                    const colorDiv = document.createElement('div');
                    colorDiv.classList.add('color-option');
                    colorDiv.style.backgroundColor = color;
                    colorDiv.style.setProperty('--glow-color', color);
                    colorDiv.addEventListener('click', () => {
                        selectedColor = color;
                        document.querySelectorAll('.color-option').forEach(c => c.classList.remove('selected'));
                        colorDiv.classList.add('selected');
                    });
                    paletteContainer.appendChild(colorDiv);
                    if (index === 0) colorDiv.classList.add('selected');
                });
            }

            function createCanvas() {
                canvasContainer.innerHTML = '';
                for (let i = 0; i < GRID_SIZE * GRID_SIZE; i++) {
                    const pixel = document.createElement('div');
                    pixel.classList.add('pixel');
                    const x = i % GRID_SIZE;
                    const y = Math.floor(i / GRID_SIZE);
                    pixel.addEventListener('click', () => handlePixelClick(x, y));
                    canvasContainer.appendChild(pixel);
                }
                pixels = document.querySelectorAll('.pixel');
            }

            async function handlePixelClick(x, y) {
                if (!writeableContract) {
                    statusText.textContent = "Please connect your wallet first.";
                    connectButton.style.display = 'block';
                    return;
                }

                const isCorrectNetwork = await checkAndSwitchNetwork();
                if (!isCorrectNetwork) return;

                statusText.textContent = `Painting pixel (${x}, ${y})...`;
                try {
                    const tx = await writeableContract.paintPixel(x, y, selectedColor, { gasLimit: 300000 });
                    statusText.textContent = `Transaction sent! Waiting for confirmation...`;
                    await tx.wait();
                } catch (error) {
                    console.error("Failed to paint pixel:", error);
                    statusText.textContent = "Transaction failed. Do you have Sepolia ETH?";
                    setTimeout(() => statusText.textContent = "Pick a color, then tap a pixel!", 3000);
                }
            }

            async function loadCanvasFromChain() {
                if (!readOnlyContract) return;
                try {
                    statusText.textContent = "Fetching canvas from the blockchain...";
                    const canvasState = await readOnlyContract.getCanvas();
                    for (let y = 0; y < GRID_SIZE; y++) {
                        for (let x = 0; x < GRID_SIZE; x++) {
                            const color = canvasState[x][y];
                            const pixelIndex = y * GRID_SIZE + x;
                            pixels[pixelIndex].style.backgroundColor = (color && color !== "") ? color : "#f0f0f0";
                        }
                    }
                    statusText.textContent = "Pick a color, then tap a pixel!";
                } catch (error) {
                    console.error("Could not fetch canvas:", error);
                    statusText.textContent = "Error connecting to the contract.";
                }
            }

            function listenForEvents() {
                readOnlyContract.on("PixelPainted", (x, y, color, painter) => {
                    const pixelIndex = y.toNumber() * GRID_SIZE + x.toNumber();
                    pixels[pixelIndex].style.backgroundColor = color;
                    if (userWalletAddress && painter.toLowerCase() === userWalletAddress.toLowerCase()) {
                         statusText.textContent = `Your pixel was painted!`;
                         setTimeout(() => statusText.textContent = "Pick a color, then tap a pixel!", 2000);
                    }
                });
            }
            
            async function connectWallet() {
                if (typeof window.ethereum === 'undefined') {
                    // **FIX:** Add a mobile-specific check for a better user experience.
                    const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);
                    if (isMobile) {
                        statusText.textContent = "To use this app, please open this page inside the MetaMask app's built-in browser.";
                    } else {
                        statusText.textContent = "No wallet detected. Please install the MetaMask browser extension.";
                    }
                    return;
                }
                
                try {
                    provider = new ethers.providers.Web3Provider(window.ethereum);
                    const isCorrectNetwork = await checkAndSwitchNetwork();
                    if (!isCorrectNetwork) return;

                    await provider.send("eth_requestAccounts", []);
                    const signer = provider.getSigner();
                    userWalletAddress = await signer.getAddress();
                    
                    readOnlyContract = new ethers.Contract(contractAddress, contractABI, provider);
                    writeableContract = new ethers.Contract(contractAddress, contractABI, signer);
                    
                    statusText.textContent = `Connected: ${userWalletAddress.substring(0, 6)}...`;
                    connectButton.style.display = 'none';

                    await loadCanvasFromChain();
                    listenForEvents();

                } catch (error) {
                    console.error("Connection failed:", error);
                    statusText.textContent = "Wallet connection was rejected.";
                }
            }

            // --- INITIALIZATION ---
            function init() {
                createCanvas();
                createPalette();
                connectButton.addEventListener('click', connectWallet);
            }
            
            init();
        };
    </script>
</body>
</html>
